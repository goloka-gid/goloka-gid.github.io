<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∏—Ä –≠–ª–ª–∏</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Lora:ital,wght@0,400;1,500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script> <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
</head>
<body>

    <div id="view-grid" class="view-section active-view">
        <h1>‚ú® –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≠–ª–ª–∏</h1>
        <div class="grid" id="main-grid"></div>
        <div class="reset-link" onclick="confirmReset()">—Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
    </div>

    <div id="view-menu" class="view-section">
        <button class="simple-back" onclick="goHome()">‚¨Ö –ö –∫–∞—Ä—Ç–µ –¥–Ω–µ–π</button>
        <h2 id="menu-title" style="margin-top: 0;"></h2>
        
        <div class="menu-container">
            <div class="menu-btn" onclick="openContent('story')">
                <span class="menu-icon">üìñ</span>
                <div>
                    <div style="font-weight:bold">–°–∫–∞–∑–æ—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</div>
                    <div style="font-size:11px; opacity:0.7">–ß–∏—Ç–∞—Ç—å –∏ —Å–ª—É—à–∞—Ç—å</div>
                </div>
            </div>

            <div class="menu-btn" onclick="openContent('video')">
                <span class="menu-icon">üé¨</span>
                <div>
                    <div style="font-weight:bold">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ</div>
                    <div style="font-size:11px; opacity:0.7">–í–æ–ª—à–µ–±–Ω—ã–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º</div>
                </div>
            </div>

            <div class="menu-btn" onclick="openContent('song')">
                <span class="menu-icon">üéµ</span>
                <div>
                    <div style="font-weight:bold">–ü–µ—Å–µ–Ω–∫–∞ –¥–Ω—è</div>
                    <div style="font-size:11px; opacity:0.7">–¢–∞–Ω—Ü—É–π –∏ –ø–æ–π</div>
                </div>
            </div>
            
            <div class="menu-btn" onclick="openContent('child')">
                <span class="menu-icon">üë∂</span>
                <div>
                    <div style="font-weight:bold">–ü—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π</div>
                    <div style="font-size:11px; opacity:0.7">–¥–æ 15 –ª–µ—Ç</div>
                </div>
            </div>

            <div class="menu-btn" onclick="openContent('adult')">
                <span class="menu-icon">üßò‚Äç‚ôÄÔ∏è</span>
                <div>
                    <div style="font-weight:bold">–í–∑—Ä–æ—Å–ª–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞</div>
                    <div style="font-size:11px; opacity:0.7">–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–±—è</div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-content" class="view-section">
        <div class="header-fixed">
            <button class="nav-btn" onclick="goHome()">üè† –î–Ω–∏</button>
            <span id="header-title" style="font-size:12px; font-weight:bold; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
            <button class="nav-btn" onclick="goBackToMenu()">üîô –ú–µ–Ω—é</button>
        </div>

        <div class="scroll-wrapper" id="scroll-box">
            <div style="padding: 15px;">
                
                <div id="video-area" style="display:none;">
                    <div class="section-box" style="text-align: center;">
                        <h3 style="color: var(--accent); margin:0 0 10px 0;">üé¨ –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!</h3>
                        <div class="video-wrapper">
                            <video id="video-player" controls playsinline></video>
                        </div>
                    </div>
                </div>

                <img id="main-image" src="" class="book-media" style="display:none;" onerror="this.style.display='none'">

                <div class="section-box" id="text-box" style="display:none;">
                    <div id="text-display" class="magic-text"></div>
                </div>

                <div class="section-box" id="audio-box" style="display:none;">
                    <h3 id="audio-title" style="color: var(--accent); margin-top:0; font-size: 16px;">üéß –°–ª—É—à–∞—Ç—å</h3>
                    <audio id="audio-player" controls></audio>
                </div>

            </div>
        </div>
        
        <button class="fab-scroll" id="scroll-btn" onclick="toggleAutoScroll()">‚ú®</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
    <div id="unlock-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--accent); margin-top:0;">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h3>
            <p>–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥:</p>
            <input type="text" id="access-code-input" class="modal-input" placeholder="–ö–æ–¥...">
            <div style="display:flex; justify-content:center;">
                <button class="modal-btn secondary" onclick="closeUnlockModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn" onclick="verifyCode()">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–ø–µ—Ä–µ—Å–∫–æ–∫) -->
    <div id="warning-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--accent); margin-top:0;">–ù–µ —Å–ø–µ—à–∏—Ç–µ!</h3>
            <p>–ù–µ–ª—å–∑—è –ø–µ—Ä–µ—Å–∫–æ—á–∏—Ç—å, –Ω–µ –ø—Ä–æ–π–¥—è –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å.</p>
            <div style="display:flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <button class="modal-btn" id="warn-btn-back" onclick="closeWarningModal()">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
                <button class="modal-btn secondary" id="warn-btn-unlock" onclick="openUnlockForNext()">–û—Ç–∫—Ä—ã—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å</button>
            </div>
        </div>
    </div>

    <script>
        // --- –î–ê–ù–ù–´–ï ---
        const items = [
            {n: "–í–æ–ª—à–µ–±–Ω–∞—è –ö–∏—Å—Ç—å", i: "üñåÔ∏è"}, {n: "–ó–µ—Ä–∫–∞–ª–æ –ú–µ—á—Ç—ã", i: "ü™û"}, {n: "–ö–æ–º–ø–∞—Å –ù–∞–º–µ—Ä–µ–Ω–∏–π", i: "üß≠"},
            {n: "–°—É–Ω–¥—É–∫ –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–µ–π", i: "üì¶"}, {n: "–ê–º—É–ª–µ—Ç –°–∏–ª—ã", i: "üßø"}, {n: "–í–æ–ª—à–µ–±–Ω—ã–π –ü–æ—è—Å", i: "üéóÔ∏è"},
            {n: "–©–∏—Ç –ù–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏", i: "üõ°Ô∏è"}, {n: "–ú–æ—Å—Ç –†–∞–¥–æ—Å—Ç–∏", i: "üåà"}, {n: "–õ–æ–≤–µ—Ü –ú—ã—Å–ª–µ–π", i: "üï∏Ô∏è"},
            {n: "–í–æ–ª—à–µ–±–Ω–∞—è –ö–Ω–æ–ø–∫–∞", i: "üîò"}, {n: "–†—é–∫–∑–∞–∫ –ü–æ–¥–¥–µ—Ä–∂–∫–∏", i: "üéí"}, {n: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –°–∞–¥", i: "üå≥"},
            {n: "–°–≤–µ—Ç–æ—Ñ–æ—Ä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è", i: "üö•"}, {n: "–î–æ–º–∏–∫ –°–ø–æ–∫–æ–π—Å—Ç–≤–∏—è", i: "üè†"}, {n: "–í–æ–ª—à–µ–±–Ω—ã–π –®–∞–≥", i: "üë£"},
            {n: "–í–æ–ª—à–µ–±–Ω—ã–µ –û—á–∫–∏", i: "üëì"}, {n: "–û–¥–µ—è–ª–æ –ó–∞–±–æ—Ç—ã", i: "üõå"}, {n: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –§–æ–Ω–∞—Ä–∏–∫", i: "üî¶"},
            {n: "–í–æ–ª—à–µ–±–Ω–æ–µ –°–µ—Ä–¥—Ü–µ", i: "üíñ"}, {n: "–õ–µ—Å –¢–∏—à–∏–Ω—ã", i: "üå≤"}, {n: "–í–æ–ª–Ω–∞ –†–∞–¥–æ—Å—Ç–∏", i: "üåä"},
            {n: "–°–≤–µ—Ç–ª—è—á–æ–∫ –ó–∞–±–æ—Ç—ã", i: "ü™î"}, {n: "–í–æ–ª—à–µ–±–Ω–æ–µ –£—Ö–æ", i: "üëÇ"}, {n: "–†–µ–∫–∞ –ü—Ä–∏–Ω—è—Ç–∏—è", i: "üö£"},
            {n: "–õ–∞–º–ø–æ—á–∫–∞ –û—Å–æ–∑–Ω–∞–Ω–∏—è", i: "üí°"}, {n: "–ö—Ä—ã–ª—å—è –ú–µ—á—Ç—ã", i: "ü™Ω"}, {n: "–ö—Ä–∏—Å—Ç–∞–ª–ª –ß–µ—Å—Ç–Ω–æ—Å—Ç–∏", i: "üíé"},
            {n: "–ó–æ–ª–æ—Ç–∞—è –ù–∏—Ç—å", i: "üßµ"}, {n: "–ó–≤–µ–∑–¥–∞ –ù–∞–¥–µ–∂–¥—ã", i: "‚≠ê"}, {n: "–í–æ–ª—à–µ–±–Ω—ã–π –ö–ª—é—á", i: "üîë"}
        ];

        let currentDayNum = 1;
        let readDays = JSON.parse(localStorage.getItem('elli_progress')) || [];
        let unlockedDays = JSON.parse(localStorage.getItem('elli_unlocked_days')) || [1, 2, 3];
        let isFullVersion = localStorage.getItem('elli_full_version') === 'true';
        let isScrolling = false;
        let scrollInterval;

        // --- 1. –û–¢–†–ò–°–û–í–ö–ê –°–ï–¢–ö–ò ---
        function renderGrid() {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';
            items.forEach((item, i) => {
                const dayNum = i + 1;
                const card = document.createElement('div');
                const isRead = readDays.includes(dayNum);
                
                // –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –ë–ª–æ–∫–∏—Ä—É–µ–º, –µ—Å–ª–∏ –¥–µ–Ω—å –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏ –Ω–µ—Ç –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏
                const isLocked = !isFullVersion && !unlockedDays.includes(dayNum);

                card.className = `day-card ${isLocked ? 'locked' : ''} ${isRead && !isLocked ? 'completed' : ''}`;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏
                card.onclick = () => handleDayClick(dayNum, item.n, isLocked, isRead);

                card.innerHTML = `
                    <div style="font-size:9px; color: ${isRead && !isLocked ? '#d4af37' : '#aaa'}; font-weight:${isRead && !isLocked ?'bold':'normal'};">–î–ï–ù–¨ ${dayNum}</div>
                    <div class="day-icon">${item.i}</div>
                    <div class="day-name">${item.n}</div>
                `;
                grid.appendChild(card);
            });
        }
        renderGrid();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –¥–Ω—é
        function handleDayClick(dayNum, name, isLocked, isRead) {
            const lastRead = readDays.length > 0 ? Math.max(...readDays) : 0;
            const nextSequential = lastRead + 1;

            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–µ–Ω—å (–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π –∏–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –ø–æ –æ—á–µ—Ä–µ–¥–∏)
            // –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –¢–∞–∫–∂–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–∫—Ä—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –¥–µ–Ω—å <= 3 (–ø–µ—Ä–≤—ã–µ –¥–Ω–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–∞–∑—É)
            if (dayNum <= nextSequential || dayNum <= 3) {
                if (isLocked) {
                    // –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω -> –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫—É–ø–∏—Ç—å
                    showUnlockModal();
                } else {
                    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç -> –∑–∞—Ö–æ–¥–∏–º
                    openDayMenu(dayNum, name);
                }
            } else {
                // –ï—Å–ª–∏ –ø—ã—Ç–∞—é—Ç—Å—è –ø–µ—Ä–µ—Å–∫–æ—á–∏—Ç—å
                showWarningModal(nextSequential);
            }
        }

        // --- 2. –û–¢–ö–†–´–¢–ò–ï –ú–ï–ù–Æ –î–ù–Ø ---
        function openDayMenu(num, name) {
            currentDayNum = num;
            
            switchView('view-menu');
            document.getElementById('menu-title').innerText = `–î–µ–Ω—å ${num}: ${name}`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç
            if (!readDays.includes(num)) {
                readDays.push(num);
                localStorage.setItem('elli_progress', JSON.stringify(readDays));
                renderGrid();
            }
        }

        // --- 3. –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–¢–ï–ù–¢–ê (HTML, –í–ò–î–ï–û, –ê–£–î–ò–û) ---
        async function openContent(type) {
            switchView('view-content');
            stopScroll(); 

            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            const container = document.getElementById('scroll-box');
            container.scrollTop = 0;
            const titleLabel = document.getElementById('header-title');
            
            const videoArea = document.getElementById('video-area');
            const videoPlayer = document.getElementById('video-player');
            const textBox = document.getElementById('text-box');
            const textDisplay = document.getElementById('text-display');
            const audioBox = document.getElementById('audio-box');
            const audioPlayer = document.getElementById('audio-player');
            const audioTitle = document.getElementById('audio-title');
            const mainImage = document.getElementById('main-image');
            const scrollBtn = document.getElementById('scroll-btn');

            // –°–ë–†–û–° –í–°–ï–ì–û –ü–ï–†–ï–î –û–¢–ö–†–´–¢–ò–ï–ú
            videoPlayer.pause();
            audioPlayer.pause();
            videoArea.style.display = 'none';
            textBox.style.display = 'none';
            audioBox.style.display = 'none';
            mainImage.style.display = 'none';
            scrollBtn.classList.remove('visible');
            textDisplay.innerHTML = ""; 

            // --- –õ–û–ì–ò–ö–ê –ü–û –¢–ò–ü–ê–ú ---
            
            // 1. –ò–°–¢–û–†–ò–Ø
            if (type === 'story') {
                titleLabel.innerText = "üìñ –ò—Å—Ç–æ—Ä–∏—è";
                await loadTextContent(`texts/day${currentDayNum}_story.html`); // –ß–∏—Ç–∞–µ–º HTML —Ñ–∞–π–ª
                
                audioBox.style.display = 'block';
                audioTitle.innerText = "üéß –°–ª—É—à–∞—Ç—å —Å–∫–∞–∑–∫—É";
                audioPlayer.src = `audio/day${currentDayNum}_story.mp3`;
                scrollBtn.classList.add('visible');

            // 2. –í–ò–î–ï–û
            } else if (type === 'video') {
                titleLabel.innerText = "üé¨ –í–∏–¥–µ–æ";
                videoArea.style.display = 'block';
                videoPlayer.src = `videos/day${currentDayNum}.mp4`;

            // 3. –ü–ï–°–ù–Ø
            } else if (type === 'song') {
                titleLabel.innerText = "üéµ –ü–µ—Å–µ–Ω–∫–∞";
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–Ω—è
                mainImage.src = `images/day${currentDayNum}.jpg`;
                mainImage.style.display = 'block';
                
                audioBox.style.display = 'block';
                audioTitle.innerText = "üéß –°–ª—É—à–∞—Ç—å –ø–µ—Å–µ–Ω–∫—É";
                audioPlayer.src = `audio/day${currentDayNum}_song.mp3`;

            // 4. –î–ï–¢–ò
            } else if (type === 'child') {
                titleLabel.innerText = "üë∂ –ü—Ä–∞–∫—Ç–∏–∫–∞ (–î–µ—Ç–∏)";
                await loadTextContent(`texts/day${currentDayNum}_child.html`);
                
                audioBox.style.display = 'block';
                audioTitle.innerText = "üéß –°–ª—É—à–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É";
                audioPlayer.src = `audio/day${currentDayNum}_child.mp3`;
                scrollBtn.classList.add('visible');

            // 5. –í–ó–†–û–°–õ–´–ï
            } else if (type === 'adult') {
                titleLabel.innerText = "üßò‚Äç‚ôÄÔ∏è –ü—Ä–∞–∫—Ç–∏–∫–∞ (–í–∑—Ä)";
                await loadTextContent(`texts/day${currentDayNum}_adult.html`);
                
                audioBox.style.display = 'block';
                audioTitle.innerText = "üéß –°–ª—É—à–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É";
                audioPlayer.src = `audio/day${currentDayNum}_adult.mp3`;
                scrollBtn.classList.add('visible');
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∞—É–¥–∏–æ, –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            if (audioBox.style.display === 'block') audioPlayer.load();
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞
        async function loadTextContent(filePath) {
            const textBox = document.getElementById('text-box');
            const textDisplay = document.getElementById('text-display');
            
            try {
                const res = await fetch(filePath);
                if (res.ok) {
                    let text = await res.text();
                    textDisplay.innerHTML = formatText(text, currentDayNum);
                    textBox.style.display = 'block';
                    // –ó–∞–ø—É—Å–∫–∞–µ–º "—É–º–Ω–æ–µ" –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ
                    initVideoObserver();
                } else {
                    textDisplay.innerHTML = "<p style='text-align:center'>–¢–µ–∫—Å—Ç —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è...</p>";
                    textBox.style.display = 'block';
                }
            } catch (e) {
                textDisplay.innerHTML = "<p style='text-align:center'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–∞ :(</p>";
                textBox.style.display = 'block';
            }
        }

        // Observer –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
        function initVideoObserver() {
            const videos = document.querySelectorAll('#text-display video');
            if (!videos.length) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.play().catch(e => console.log('Autoplay blocked', e));
                    } else {
                        entry.target.pause();
                    }
                });
            }, { threshold: 0.1 }); // –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –≤–∏–¥–Ω–æ 10% –≤–∏–¥–µ–æ

            videos.forEach(video => observer.observe(video));
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–æ–∫ [IMAGE] –∏ [GIF]
        function formatText(text, dayNum) {
            if (!text) return "";
            // –ö–∞—Ä—Ç–∏–Ω–∫–∏
            let html = text.replace(/\[IMAGE(\d*)\]/g, (match, p1) => {
                const suffix = p1 ? `_${p1}` : ''; 
                return `<img src="images/day${dayNum}${suffix}.jpg" class="book-media" onerror="this.style.display='none'">`;
            });
            // –ì–∏—Ñ–∫–∏
            html = html.replace(/\[GIF(\d*)\]/g, (match, p1) => {
                const suffix = p1 ? `_${p1}` : '';
                return `<img src="images/day${dayNum}${suffix}.gif" class="book-media" onerror="this.style.display='none'">`;
            });
            // –í–∏–¥–µ–æ (–∫–∞–∫ –≥–∏—Ñ–∫–∏)
            html = html.replace(/\[VID(\d*)\]/g, (match, p1) => {
                const suffix = p1 ? `_${p1}` : '';
                return `<video src="videos/day${dayNum}${suffix}.mp4" class="book-media" autoplay muted loop playsinline onerror="this.style.display='none'"></video>`;
            });
            return html;
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function goBackToMenu() {
            stopScroll();
            document.getElementById('audio-player').pause();
            document.getElementById('video-player').pause();
            switchView('view-menu');
        }

        function goHome() {
            stopScroll();
            document.getElementById('audio-player').pause();
            document.getElementById('video-player').pause();
            switchView('view-grid');
        }

        // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
        function toggleAutoScroll() {
            const container = document.getElementById('scroll-box');
            const btn = document.getElementById('scroll-btn');
            
            if (isScrolling) {
                clearInterval(scrollInterval);
                btn.classList.remove('active');
            } else {
                scrollInterval = setInterval(() => {
                    container.scrollTop += 1; 
                    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 2) {
                        stopScroll();
                    }
                }, 35);
                btn.classList.add('active');
            }
            isScrolling = !isScrolling;
        }

        function stopScroll() {
            clearInterval(scrollInterval);
            isScrolling = false;
            const btn = document.getElementById('scroll-btn');
            if(btn) btn.classList.remove('active');
        }

        // --- 4. –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –ò –õ–û–ì–ò–ö–ê ---
        
        // –û–∫–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        function showUnlockModal() {
            document.getElementById('unlock-modal').classList.add('visible');
            document.getElementById('access-code-input').value = '';
            document.getElementById('access-code-input').focus();
        }

        function closeUnlockModal() {
            document.getElementById('unlock-modal').classList.remove('visible');
        }

        // –û–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–ø–µ—Ä–µ—Å–∫–æ–∫)
        function showWarningModal(nextDay) {
            const modal = document.getElementById('warning-modal');
            const unlockBtn = document.getElementById('warn-btn-unlock');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ "—Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π" –¥–µ–Ω—å
            const isNextLocked = !isFullVersion && !unlockedDays.includes(nextDay);
            
            if (isNextLocked) {
                unlockBtn.style.display = 'block';
                unlockBtn.innerText = `–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –î–µ–Ω—å ${nextDay}`;
                unlockBtn.onclick = () => {
                    closeWarningModal();
                    showUnlockModal();
                };
            } else {
                unlockBtn.style.display = 'block';
                unlockBtn.innerText = `–ü–µ—Ä–µ–π—Ç–∏ –∫ –î–Ω—é ${nextDay}`;
                unlockBtn.onclick = () => {
                    closeWarningModal();
                    // –ù–∞—Ö–æ–¥–∏–º –∏–º—è –¥–Ω—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
                    const item = items[nextDay - 1];
                    openDayMenu(nextDay, item ? item.n : '');
                };
            }
            
            modal.classList.add('visible');
        }

        function closeWarningModal() {
            document.getElementById('warning-modal').classList.remove('visible');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        async function verifyCode() {
            const inputElement = document.getElementById('access-code-input');
            const code = inputElement.value.trim();
            if (!code) return;

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥—ã –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ JSON —Ñ–∞–π–ª–∞
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º
                const response = await fetch(`codes.json?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error(`–§–∞–π–ª –∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω (Status: ${response.status})`);
                }
                
                const codes = await response.json();
                
                // –ò—â–µ–º –∫–æ–¥ (—É—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)
                // –ö–ª—é—á–∏ –≤ JSON –ª—É—á—à–µ –¥–µ—Ä–∂–∞—Ç—å –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
                let accessValue = codes[code] || codes[code.toUpperCase()];
                
                // –ï—Å–ª–∏ –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞–ø—Ä—è–º—É—é, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–±—Ä–∞—Ç—å –∫–ª—é—á–∏ (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π/–ø—Ä–æ–±–µ–ª–∞–º–∏)
                if (accessValue === undefined) {
                    const foundKey = Object.keys(codes).find(k => k.toUpperCase().trim() === code.toUpperCase());
                    if (foundKey) accessValue = codes[foundKey];
                }

                if (accessValue !== undefined) {
                    let unlockedWhat = "";

                    // 1. –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
                    if (accessValue === "full") {
                        isFullVersion = true;
                        localStorage.setItem('elli_full_version', 'true');
                        unlockedWhat = "–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø";
                        alert("üéâ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –í—Å–µ –¥–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã!");
                    } 
                    // 2. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–¥ ("single")
                    else if (accessValue === "single") {
                        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π –¥–µ–Ω—å. 
                        // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç (—á—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ), –Ω–∞—á–∏–Ω–∞–µ–º —Å 3 (—Ç–∞–∫ –∫–∞–∫ 1-3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
                        const maxUnlocked = unlockedDays.length > 0 ? Math.max(...unlockedDays) : 3;
                        const newDay = maxUnlocked + 1;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–æ–π –¥–µ–Ω—å –≤–æ–æ–±—â–µ –≤ —Å–ø–∏—Å–∫–µ items
                        if (newDay > items.length) {
                            alert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–Ω–∏.");
                            return;
                        }

                        if (!unlockedDays.includes(newDay)) {
                            unlockedDays.push(newDay);
                            localStorage.setItem('elli_unlocked_days', JSON.stringify(unlockedDays));
                        }
                        unlockedWhat = `–î–µ–Ω—å ${newDay}`;
                        alert(`üéâ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –û—Ç–∫—Ä—ã—Ç –î–µ–Ω—å ${newDay}`);
                    }
                    // 3. –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (—á–∏—Å–ª–æ)
                    else if (typeof accessValue === 'number') {
                        const dayToOpen = parseInt(accessValue);
                        if (!unlockedDays.includes(dayToOpen)) {
                            unlockedDays.push(dayToOpen);
                            localStorage.setItem('elli_unlocked_days', JSON.stringify(unlockedDays));
                        }
                        unlockedWhat = `–î–µ–Ω—å ${dayToOpen}`;
                        alert(`üéâ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –û—Ç–∫—Ä—ã—Ç –î–µ–Ω—å ${dayToOpen}`);
                    }

                    renderGrid();
                    closeUnlockModal();
                    sendTelegramNotification(code, unlockedWhat);

                } else {
                    alert("‚õî –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.");
                }
            } catch (e) {
                console.error("Critical error in verifyCode:", e);
                alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã: ${e.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª codes.json –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä.`);
            }
        }

        // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function confirmReset() {
            const isConfirmed = confirm("‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?\n\n–í—ã –ø–æ–ø–∞–¥–µ—Ç–µ –≤ –¥–µ–º–æ —Ä–µ–∂–∏–º, –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –¥–Ω–∏ –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã.\n\n–ù–∞–∂–º–∏—Ç–µ –û–ö —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –û—Ç–º–µ–Ω–∞.");
            if (isConfirmed) {
                localStorage.removeItem('elli_progress');
                localStorage.removeItem('elli_full_version');
                localStorage.removeItem('elli_unlocked_days');
                location.reload();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        async function sendTelegramNotification(code, type) {
            // –ë–µ—Ä–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ APP_CONFIG (–∏–∑ —Ñ–∞–π–ª–∞ config.js)
            // –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã, –≤—ã—Ö–æ–¥–∏–º
            if (typeof APP_CONFIG === 'undefined' || !APP_CONFIG.telegram.enabled) return;
            
            const { botToken, chatId } = APP_CONFIG.telegram;
            if (botToken === "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê" || !botToken) return;

            const message = `üîî <b>–ù–æ–≤–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è!</b>%0A%0Aüîë –ö–æ–¥: <code>${code}</code>%0AüéÅ –î–æ—Å—Ç—É–ø: ${type}`;
            const url = `https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${message}&parse_mode=HTML`;

            try {
                await fetch(url);
                console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", err);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        tg.setHeaderColor('#fdfbf7'); 
        tg.setBackgroundColor('#fdfbf7');
        
        // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ (—Å–∏—Å—Ç–µ–º–Ω–∞—è)
        tg.BackButton.onClick(() => {
            if (document.getElementById('view-menu').classList.contains('active-view')) goHome();
            else if (document.getElementById('view-content').classList.contains('active-view')) goBackToMenu();
        });
        
        setInterval(() => {
            if (document.getElementById('view-grid').classList.contains('active-view')) tg.BackButton.hide();
            else tg.BackButton.show();
        }, 200);

    </script>
</body>
</html>
